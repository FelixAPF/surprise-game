<div class="game-container">
  
  <div class="rules-overlay" *ngIf="gs.gameState() === 'RULES'">
    <div class="rules-card fade-in-delayed">
      <h1 class="rules-title">RÃˆGLES DU JEU</h1>
      
      <div class="rules-grid">
        <div class="rules-section">
          <h3>COMMENT JOUER</h3>
          <ul class="steps-list">
            <li>
              <span class="step-num">1</span>
              <span>Choisissez votre <strong>Valise Personnelle</strong>.</span>
            </li>
            <li>
              <span class="step-num">2</span>
              <span>Ouvrez les autres valises pour <strong>Ã©liminer</strong> les prix.</span>
            </li>
            <li>
              <span class="step-num">3</span>
              <span>Ã€ la fin, gardez votre valise ou <strong>Ã©changez-la</strong>.</span>
            </li>
          </ul>
        </div>

        <div class="rules-section">
          <h3>CATÃ‰GORIES DE PRIX</h3>
          <div class="category-legend">
            <div *ngFor="let category of categoriesKeys">
              <div class="legend-item" [ngClass]="categories[category].title">
                <div class="dot"></div>
                <span>{{categories[category].title}}</span>
                <small>{{categories[category].description}}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button class="big-start-btn" (click)="confirmRules()">J'AI COMPRIS</button>
    </div>
  </div>

  <div class="title-card-overlay" *ngIf="showRoundTitle()">
    <div class="title-content">
      <h1 class="netflix-anim">{{ currentRoundTitle() }}</h1>
      <div class="title-bar"></div>
    </div>
  </div>

  <div class="board-area" id="main-board" *ngIf="gs.gameState() !== 'SETUP' && gs.gameState() !== 'RULES'">
    <header class="game-header">
      <h1 *ngIf="gs.gameState() === 'PICK_OWN'">Choisissez votre valise</h1>
      <h1 *ngIf="gs.gameState() === 'PLAYING' && !showRoundTitle()">
        Manche {{gs.currentRoundIndex() + 1}} <span style="color:#666; margin: 0 15px;">|</span> <span style="color:#e50914">Ouvrir {{remainingToOpen()}}</span>
      </h1>
      <h1 *ngIf="gs.gameState() === 'SWAP_ROUND' && !showRoundTitle()">DÃ©cision Finale</h1>
      <h1 *ngIf="gs.gameState() === 'FINISHED' && !isPlayingVideo() && !zoomedCase">RÃ©sumÃ©</h1>
    </header>

    <div class="grid">
      <div *ngFor="let c of boardCases" 
           class="briefcase"
           [class.open]="c.isOpen"
           (click)="handleCaseClick(c)">
        <span>{{c.id}}</span>
      </div>
    </div>

    <div class="held-section" *ngIf="heldCase()">
      <h3>VOTRE VALISE</h3>
      <div class="briefcase held" [class.open]="heldCase()?.isOpen">
        <span>{{heldCase()?.id}}</span>
      </div>
    </div>
  </div>

  <div class="board-area" *ngIf="gs.gameState() === 'SETUP'">
    <header class="game-header" style="z-index: 100;">
      <h1 class="netflix-anim" style="font-size: 6rem; color: #e50914; margin-bottom: 10px;">SURPRISE GAME</h1>
      <p class="fade-in-delayed" style="font-size: 1.5rem; color: #999; letter-spacing: 5px; font-weight: 300;">UNE PRODUCTION ORIGINALE</p>
      
      <div class="fade-in-delayed" style="margin-top: 60px;">
        <div *ngIf="gs.prizes().length === 16; else notReady">
          <button class="big-start-btn" (click)="gs.startGame()">JOUER</button>
        </div>
        <ng-template #notReady>
          <div style="color: #666;">
            <p style="margin-bottom: 20px;">INITIALISATION DU SYSTÃˆME...</p>
            <a routerLink="/admin" style="color: #e50914; text-decoration: none; border: 1px solid #333; padding: 10px 20px; border-radius: 4px;">ACCÃˆS ADMIN</a>
          </div>
        </ng-template>
      </div>
    </header>
  </div>

  <div class="sidebar" *ngIf="gs.gameState() !== 'RULES'">
    <div style="margin-bottom: 20px; color: #666; font-size: 0.8rem; letter-spacing: 2px; font-weight: bold; text-align: right;">
      PRIX RESTANTS
    </div>
    <div *ngFor="let p of gs.sortedPrizes()" class="prize-row" [ngClass]="p.category" [class.eliminated]="p.isRevealed">
      <span class="prize-name" style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
        {{ p.isRevealed ? p.name : "?" }}
      </span>
    </div>
  </div>

</div>

<div class="overlay" *ngIf="zoomedCase" (click)="closeZoom()">
  <div class="zoom-card" 
       [class]="zoomedCase.prize.category" 
       [class.locked-shaking]="!isRevealed()"
       (click)="$event.stopPropagation()">
    <div *ngIf="!isRevealed()" class="locked-state">
      <div class="lock-icon">ðŸ”’</div>
      <h2>CLASSIFIED</h2>
      <div class="pulsing-bar"></div>
    </div>
    <div *ngIf="isRevealed()" class="card-content fade-in-content">
      <div style="font-size: 1rem; color: #888; letter-spacing: 4px; margin-bottom: 15px; font-weight: bold;">
        VALISE {{zoomedCase.id}}
      </div>
      <img [src]="zoomedCase.prize.imageUrl" class="reveal-img">
      <div class="prize-info">
        <h3>{{zoomedCase.prize.name}}</h3>
        <p class="prize-category">{{zoomedCase.prize.category}}</p>
      </div>
    </div>
  </div>
</div>

<div class="overlay" *ngIf="gs.gameState() === 'SWAP_ROUND'">
  <div class="swap-card">
    <h2>Il reste une valise</h2>
    <p style="color: #aaa; margin: 20px 0;">Voulez-vous Ã©changer votre valise ?</p>
    <div class="actions">
      <button (click)="gs.keepCase()">GARDER {{heldCase()?.id}}</button>
      <button (click)="gs.swapCase()" style="background: #333; color: white;">Ã‰CHANGER</button>
    </div>
  </div>
</div>

<div class="overlay video-overlay" *ngIf="isPlayingVideo()">
  <video *ngIf="videoType() === 'GENERIC'"
         [src]="safeVideoUrl()" 
         autoplay 
         (ended)="onVideoEnded()"
         class="fullscreen-video">
  </video>
  <div *ngIf="videoType() === 'CLIP' || videoType() === 'YOUTUBE_STANDARD'" class="youtube-wrapper">
    <iframe *ngIf="videoType() === 'YOUTUBE_STANDARD'"
            id="yt-player-frame"
            [src]="youTubeEmbedUrl()"
            width="100%" height="100%" frameborder="0" 
            allow="autoplay; encrypted-media" allowfullscreen>
    </iframe>
    <iframe *ngIf="videoType() === 'CLIP'"
            [src]="youTubeEmbedUrl()"
            width="100%" height="100%" frameborder="0" 
            allow="autoplay; encrypted-media" allowfullscreen>
    </iframe>
  </div>
  <button class="skip-btn" (click)="onVideoEnded()">VOIR LES PRIX</button>
</div>

<div class="overlay" *ngIf="gs.gameState() === 'FINISHED' && !isPlayingVideo() && !zoomedCase">
  <canvas #winnerCanvas class="fireworks-canvas"></canvas>
  <div class="summary-board">
    <div class="winner-section">
      <h1 class="winner-title">FÃ‰LICITATIONS</h1>
      <div class="zoom-card winner" [class]="heldCase()?.prize?.category">
        <div class="card-content">
          <img [src]="heldCase()?.prize?.imageUrl" class="reveal-img large">
          <h2>{{heldCase()?.prize?.name}}</h2>
          <p class="prize-category">{{heldCase()?.prize?.category}}</p>
        </div>
      </div>
      <button class="play-again-btn" (click)="resetGame()">REJOUER</button>
    </div>
    <div class="others-section">
      <h3>Les Autres Prix</h3>
      <div class="others-grid">
        <div *ngFor="let p of unwonPrizes()" class="mini-card" [ngClass]="p.category">
          <div class="mini-info">
            <span class="mini-name">{{p.name}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>